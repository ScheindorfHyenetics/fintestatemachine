<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr">

<head>
    <title>Automate à etat fini</title>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <style>
        @font-face {
    font-family: kellyangothique;
    src:  url(./KELLYAG.TTF);
    font-weight: 100;
        }
          @font-face {
    font-family: deadjim;
    src:  url(./DEADJIM.TTF);
    font-weight: bold;
        }
         @font-face {
    font-family: fatality;
    src:  url(./Fatalitys-Edge.ttf);
    font-weight: 200;
        }

    #left {
        z-index: -1;
        position: absolute;
        left: 0px;
        margin: 0px;
        padding: 0px;
        top: 0px;
        height: 100%;
        width: 20%;
        background-color: orange;
        border-right-width: 30px;
        border-right-color: gray;
        border-right-style: double;
    }
    #middle {
    z-index: 30;
    position: absolute;
    left: 22%;
    margin: 0px;
    padding: 0px;
    top: 0px;
    height: 100%;
    width: 45%;
    background-color: rgba(150,150,100,1);
    border-right-width: 20px;
    border-right-color: green;
    border-right-style: dashed ;
    }
    #right {
    z-index: -1;
    position: absolute;
    left: 68%;
    margin: 0px;
    padding: 0px;
    top: 0px;
    height: 100%;
    width: 30%;
    background-color: green;
    border-right-width: 50px;
    border-right-color: yellow;
    border-right-style: dotted ;
    }
    body {
        background-color: black;
        padding: 0px;
        margin: 0px;
    }
    #genauto {
        font-family: deadjim;
        font-size: 20pt;
        font-weight: bold;
        transition: all 1s;
    }
    #genauto:hover {
       font-family: fatality;
        font-size: 30pt;
        font-weight: normal;
    }
    .state_down {

    }
    .draggable {
        cursor: grab;
    }
    .dropper {
        cursor: grabing;
    }
    .drop_hover {
        color: white;
    }
    .common {
        color: red;
    }
    .initial {
        color: blue;
    }
    .final {
        color: yellow;
    }
    .actif {
        color: green !important;
    }
    </style>
</head>

<body>

<svg width="1000" height="1000" style="z-index:0;">
  <g id="genauto" onclick="newstate()">
    <circle cx="100" cy="100" r="50" style="z-index: 10;"></circle>
    <text x="20" y="180" class="mecha">Generer un etat</text>
  </g>
</svg>

    <nav id="left">

    </nav>
    <section id="middle">
    <svg id="middlesvg" height="1000" width="1000" style="z-index: -1" class="dropper">
     <defs>
        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:rgb(255,0,0);stop-opacity:1" />
          <stop offset="100%" style="stop-color:rgb(0,255,0);stop-opacity:1" />
        </linearGradient>
      </defs>
    </svg>
    </section>
    <footer id="right"  style="z-index: 20">


    </footer>
    <!-- ><script src="./dragndrop.js" type="text/javascript"></script> -->
    <script>
        const svgns = "http://www.w3.org/2000/svg";
        let gel = (id) => {return document.getElementById(id)};
        let uid = [];
        let drag = false;
        let dragget = null;
        let states = [];
        let connec = [];
        let labels = [];
        let connect = false;
        let middlesvg = gel('middlesvg');
        let left = gel('left');
        function newstate(click) {
            let x = false;
            let pass = false;
            news = document.createElementNS(svgns, 'circle');
            while (!pass) {
            pass = true;
            news.id = Math.round( Math.random() * 10000);
            for (x in uid) {
                    if (x == news.id) {
                        pass = false;
                    }
                }
            }
            console.log("nouvel objet state id="+news.id)
            uid[news.id] = news;
            states[news.id] = "down";
            connec[news.id] = [];
            news.setAttribute('class',"state common draggable");
            news.setAttribute('cx',Math.round(Math.random()*500));
            news.setAttribute('cy',Math.round(Math.random()*500));
            news.setAttribute('r',30);
            news.setAttribute('fill',"red");
            news.style.zIndex = 20;
            let label = document.createElementNS(svgns, 'text');
            labels[news.id] =  label;
            label.id = "label" + news.id;
            label.textContent = news.id;
            label.setAttribute('x',''+news.cx.baseVal.value);
            label.setAttribute('y',''+(news.cy.baseVal.value+20))
            label.style.position = "absolute";
            label.class = "draggable";
            console.log(news)
            console.log(label)
            console.log("added label " + label.style.left + " " + label.style.top + " " + label.textContent)
            //left.parentNode.insertBefore(news,left.parentNode.firstChild)
            //left.parentNode.insertBefore(label,left.parentNode.firstChild)
            middlesvg.appendChild(news);
            middlesvg.appendChild(label);
            //refresh();
            news.addEventListener("mousedown",mousedown);
            news.addEventListener("dblclick",deplace);
        }

        function purgeandrefresh() {
            let lignes = document.getElementsByClassName("connection");
            for (k = 0;k < lignes.length;k++) {
                lignes[k].parentNode.removeChild(lignes[k]);
            }
            let states = document.getElementsByClassName("state");
            for (k = 0;k < states.length;k++) {
                let linear = "url(#grad1)";
                let x = states[k];
                for (y in connec[x.id]) {
                    let peer = connec[x.id][y][0];
                    let line = document.createElementNS(svgns,"line");
                    line.setAttribute('x1',x.getAttribute('cx'));
                    line.setAttribute('y1',x.getAttribute('cy'));
                    line.setAttribute('x2',peer.getAttribute('cx'));
                    line.setAttribute('y2',peer.getAttribute('cy'));
                    line.setAttribute('stroke',"black");
                    line.setAttribute('stroke-width', 5);
                    line.setAttribute('class', 'connection');
                    middlesvg.appendChild(line);

                }
            }
        }

        function deplace (event) {
            if (connect == false){
                   connect = event.target;
                    event.target.setAttribute('fill','blue');
                }

        }
        function mousedown(event) {
            if (!event) return;
            if (event.offsetX <= 0 || event.offsetY <= 0) {
                return;
            }
            if (connect) {
                /*for (i in connec[connect.id]) {
                    if (connec[connect.id][i][0].id == event.target.id) {
                        //alert(connec[connect.id][i][0].id + " "+connect.id );
                        //console.log(connect); console.log(connec[connect.id]);
                        //alert('already connected');
                        connect.setAttribute('fill','red');
                        connect = false;
                        return;
                    }
                }*/
                connec[connect.id].push([event.target,prompt('transition key')]);
                connect.setAttribute('fill','red');
                //alert(connect.id + ' racordé a ' + event.target.id);
                connect = false;
                return;
            }
            if (event.shiftKey) {
                let id = event.target.id;
                labels[id].parentNode.removeChild(labels[id]);
                delete labels[id];
                delete connec[id];
                delete states[id];
                event.target.parentNode.removeChild(event.target);
                delete uid[id];
            }
            if (!drag && !event.shiftKey)  {
            console.log(event);
            drag = true;
            dragget = event.target;
            }
        }
        function mouseup(event) {
            if (!event) return;
            if (event.offsetX <= 0 || event.offsetY <= 0) {
                return;
            }
            if (drag) {
                drag = false;
                dragget.setAttribute('cx',Number(event.layerX));
                dragget.setAttribute('cy',Number(event.layerY)+20);
                labels[dragget.id].setAttribute('x',Number(event.layerX));
                labels[dragget.id].setAttribute('y',Number(event.layerY)+20);
                dragget = null;
            }
        }

        let genauto = gel('genauto');
        genauto.addEventListener("onclick",newstate);
        middlesvg.addEventListener("mouseup",mouseup);

        middlesvg.addEventListener('mousemove',function (event) {
            if (!event) return;
            if (event.offsetX <= 0 || event.offsetY <= 0) {
                return;
            }
            if (event.target != middlesvg) {
                return;
            }
            if (drag) {
                dragget.setAttribute('cx',Number(event.offsetX));
                dragget.setAttribute('cy',Number(event.offsetY));
                labels[dragget.id].setAttribute('x',Number(event.offsetX));
                labels[dragget.id].setAttribute('y',Number(event.offsetY)+20);
                console.log(event)
            }
        })

        setInterval(purgeandrefresh, 100)
    </script>
    <noscript>Veuillez rafraichir la page en activant javascript</noscript>
</body>

</html>
